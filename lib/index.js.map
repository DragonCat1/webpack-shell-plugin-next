{"version":3,"file":"index.js","sources":["../src/webpack-shell-plugin-next.js"],"sourcesContent":["const spawn = require('child_process').spawn;\nconst exec = require('child_process').exec;\nconst os = require('os');\n\nconst defaultOptions = {\n  onBuildStart: [],\n  onBuildEnd: [],\n  onBuildExit: [],\n  dev: true,\n  safe: false\n};\n\nexport default class WebpackShellPlugin {\n  constructor(options) {\n    this.options = this.validateInput(this.mergeOptions(options, defaultOptions));\n  }\n\n  puts(error, stdout, stderr) {\n    if (error) {\n      throw error;\n    }\n  }\n\n  spreadStdoutAndStdErr(proc) {\n    proc.stdout.pipe(process.stdout);\n    proc.stderr.pipe(process.stdout);\n  }\n\n  serializeScript(script) {\n    if (typeof script === 'string') {\n      const [command, ...args] = script.split(' ');\n      return {command, args};\n    }\n    const {command, args} = script;\n    return {command, args};\n  }\n\n  handleScript(script) {\n    if (os.platform() === 'win32' || this.options.safe) {\n      this.spreadStdoutAndStdErr(exec(script, this.puts));\n    } else {\n      const {command, args} = this.serializeScript(script);\n      const proc = spawn(command, args, {stdio: 'inherit'});\n      proc.on('close', this.puts);\n    }\n  }\n\n  validateInput(options) {\n    if (typeof options.onBuildStart === 'string') {\n      options.onBuildStart = options.onBuildStart.split('&&');\n    }\n    if (typeof options.onBuildEnd === 'string') {\n      options.onBuildEnd = options.onBuildEnd.split('&&');\n    }\n    if (typeof options.onBuildExit === 'string') {\n      options.onBuildExit = options.onBuildExit.split('&&');\n    }\n    return options;\n  }\n\n  mergeOptions(options, defaults) {\n    for (const key in defaults) {\n      if (options.hasOwnProperty(key)) {\n        defaults[key] = options[key];\n      }\n    }\n    return defaults;\n  }\n\n  \n  apply(compiler) {\n    compiler.hooks.compilation.tap('webpack-shell-plugin-next', (compilation) => {\n      if (this.options.verbose) {\n        console.log(`Report compilation: ${compilation}`);\n        console.warn(`WebpackShellPlugin [${new Date()}]: Verbose is being deprecated, please remove.`);\n      }\n      if (this.options.onBuildStart.length) {\n        console.log('Executing pre-build scripts');\n        for (let i = 0; i < this.options.onBuildStart.length; i++) {\n          this.handleScript(this.options.onBuildStart[i]);\n        }\n        if (this.options.dev) {\n          this.options.onBuildStart = [];\n        }\n      }\n    });\n\n    compiler.hooks.afterEmit.tapAsync('webpack-shell-plugin-next', (compilation, callback) => {\n      if (this.options.onBuildEnd.length) {\n        console.log('Executing post-build scripts');\n        for (let i = 0; i < this.options.onBuildEnd.length; i++) {\n          this.handleScript(this.options.onBuildEnd[i]);\n        }\n        if (this.options.dev) {\n          this.options.onBuildEnd = [];\n        }\n      }\n      return callback();\n    });\n\n    compiler.hooks.done.tap('webpack-shell-plugin-next', () => {\n      if (this.options.onBuildExit.length) {\n        console.log('Executing additional scripts before exit');\n        for (let i = 0; i < this.options.onBuildExit.length; i++) {\n          this.handleScript(this.options.onBuildExit[i]);\n        }\n      }\n    });\n  }\n}\n"],"names":["spawn","require","exec","os","defaultOptions","WebpackShellPlugin","options","validateInput","mergeOptions","error","stdout","stderr","proc","pipe","process","script","split","command","args","platform","safe","spreadStdoutAndStdErr","puts","serializeScript","stdio","on","onBuildStart","onBuildEnd","onBuildExit","defaults","key","hasOwnProperty","compiler","hooks","compilation","tap","verbose","log","warn","Date","length","i","handleScript","dev","afterEmit","tapAsync","callback","done"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,IAAMA,QAAQC,QAAQ,eAAR,EAAyBD,KAAvC;AACA,IAAME,OAAOD,QAAQ,eAAR,EAAyBC,IAAtC;AACA,IAAMC,KAAKF,QAAQ,IAAR,CAAX;;AAEA,IAAMG,iBAAiB;gBACP,EADO;cAET,EAFS;eAGR,EAHQ;OAIhB,IAJgB;QAKf;CALR;;IAQqBC;8BACPC,OAAZ,EAAqB;;;SACdA,OAAL,GAAe,KAAKC,aAAL,CAAmB,KAAKC,YAAL,CAAkBF,OAAlB,EAA2BF,cAA3B,CAAnB,CAAf;;;;;yBAGGK,OAAOC,QAAQC,QAAQ;UACtBF,KAAJ,EAAW;cACHA,KAAN;;;;;0CAIkBG,MAAM;WACrBF,MAAL,CAAYG,IAAZ,CAAiBC,QAAQJ,MAAzB;WACKC,MAAL,CAAYE,IAAZ,CAAiBC,QAAQJ,MAAzB;;;;oCAGcK,QAAQ;UAClB,OAAOA,MAAP,KAAkB,QAAtB,EAAgC;4BACHA,OAAOC,KAAP,CAAa,GAAb,CADG;;YACvBC,QADuB;YACXC,KADW;;eAEvB,EAACD,iBAAD,EAAUC,WAAV,EAAP;;UAEKD,OALe,GAKEF,MALF,CAKfE,OALe;UAKNC,IALM,GAKEH,MALF,CAKNG,IALM;;aAMf,EAACD,gBAAD,EAAUC,UAAV,EAAP;;;;iCAGWH,QAAQ;UACfZ,GAAGgB,QAAH,OAAkB,OAAlB,IAA6B,KAAKb,OAAL,CAAac,IAA9C,EAAoD;aAC7CC,qBAAL,CAA2BnB,KAAKa,MAAL,EAAa,KAAKO,IAAlB,CAA3B;OADF,MAEO;+BACmB,KAAKC,eAAL,CAAqBR,MAArB,CADnB;YACEE,OADF,oBACEA,OADF;YACWC,IADX,oBACWA,IADX;;YAECN,OAAOZ,MAAMiB,OAAN,EAAeC,IAAf,EAAqB,EAACM,OAAO,SAAR,EAArB,CAAb;aACKC,EAAL,CAAQ,OAAR,EAAiB,KAAKH,IAAtB;;;;;kCAIUhB,SAAS;UACjB,OAAOA,QAAQoB,YAAf,KAAgC,QAApC,EAA8C;gBACpCA,YAAR,GAAuBpB,QAAQoB,YAAR,CAAqBV,KAArB,CAA2B,IAA3B,CAAvB;;UAEE,OAAOV,QAAQqB,UAAf,KAA8B,QAAlC,EAA4C;gBAClCA,UAAR,GAAqBrB,QAAQqB,UAAR,CAAmBX,KAAnB,CAAyB,IAAzB,CAArB;;UAEE,OAAOV,QAAQsB,WAAf,KAA+B,QAAnC,EAA6C;gBACnCA,WAAR,GAAsBtB,QAAQsB,WAAR,CAAoBZ,KAApB,CAA0B,IAA1B,CAAtB;;aAEKV,OAAP;;;;iCAGWA,SAASuB,aAAU;WACzB,IAAMC,GAAX,IAAkBD,WAAlB,EAA4B;YACtBvB,QAAQyB,cAAR,CAAuBD,GAAvB,CAAJ,EAAiC;sBACtBA,GAAT,IAAgBxB,QAAQwB,GAAR,CAAhB;;;aAGGD,WAAP;;;;0BAIIG,UAAU;;;eACLC,KAAT,CAAeC,WAAf,CAA2BC,GAA3B,CAA+B,2BAA/B,EAA4D,UAACD,WAAD,EAAiB;YACvE,MAAK5B,OAAL,CAAa8B,OAAjB,EAA0B;kBAChBC,GAAR,0BAAmCH,WAAnC;kBACQI,IAAR,0BAAoC,IAAIC,IAAJ,EAApC;;YAEE,MAAKjC,OAAL,CAAaoB,YAAb,CAA0Bc,MAA9B,EAAsC;kBAC5BH,GAAR,CAAY,6BAAZ;eACK,IAAII,IAAI,CAAb,EAAgBA,IAAI,MAAKnC,OAAL,CAAaoB,YAAb,CAA0Bc,MAA9C,EAAsDC,GAAtD,EAA2D;kBACpDC,YAAL,CAAkB,MAAKpC,OAAL,CAAaoB,YAAb,CAA0Be,CAA1B,CAAlB;;cAEE,MAAKnC,OAAL,CAAaqC,GAAjB,EAAsB;kBACfrC,OAAL,CAAaoB,YAAb,GAA4B,EAA5B;;;OAXN;;eAgBSO,KAAT,CAAeW,SAAf,CAAyBC,QAAzB,CAAkC,2BAAlC,EAA+D,UAACX,WAAD,EAAcY,QAAd,EAA2B;YACpF,MAAKxC,OAAL,CAAaqB,UAAb,CAAwBa,MAA5B,EAAoC;kBAC1BH,GAAR,CAAY,8BAAZ;eACK,IAAII,IAAI,CAAb,EAAgBA,IAAI,MAAKnC,OAAL,CAAaqB,UAAb,CAAwBa,MAA5C,EAAoDC,GAApD,EAAyD;kBAClDC,YAAL,CAAkB,MAAKpC,OAAL,CAAaqB,UAAb,CAAwBc,CAAxB,CAAlB;;cAEE,MAAKnC,OAAL,CAAaqC,GAAjB,EAAsB;kBACfrC,OAAL,CAAaqB,UAAb,GAA0B,EAA1B;;;eAGGmB,UAAP;OAVF;;eAaSb,KAAT,CAAec,IAAf,CAAoBZ,GAApB,CAAwB,2BAAxB,EAAqD,YAAM;YACrD,MAAK7B,OAAL,CAAasB,WAAb,CAAyBY,MAA7B,EAAqC;kBAC3BH,GAAR,CAAY,0CAAZ;eACK,IAAII,IAAI,CAAb,EAAgBA,IAAI,MAAKnC,OAAL,CAAasB,WAAb,CAAyBY,MAA7C,EAAqDC,GAArD,EAA0D;kBACnDC,YAAL,CAAkB,MAAKpC,OAAL,CAAasB,WAAb,CAAyBa,CAAzB,CAAlB;;;OAJN;;;;;;;;"}